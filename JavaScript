document.addEventListener('DOMContentLoaded', () => {
    const addBtn = document.getElementById('add-Tab-Btn');
    const tabBar = document.getElementById('tab-Bar');
    const tabContainer = document.getElementById('tab-Container');
    let count = 0;

    addBtn.onclick = () => newTab();
    load();

    function newTab(content = '', name = null) {
        const id = ++count;
        const n = name || `Note ${id}`;
        
        // Tab
        const tab = document.createElement('button');
        tab.className = 'tab-button';
        tab.id = `tab-${id}`;
        tab.innerHTML = `<span>${n}</span><span class="tab-close">×</span>`;
        tab.onclick = e => e.target.classList.contains('tab-close') 
            ? confirm('Törlöd?') && del(id) 
            : active(id);
        
        // Content
        const div = document.createElement('div');
        div.className = 'tab-content';
        div.id = `content-${id}`;
        div.innerHTML = `<textarea oninput="save()">${content}</textarea>`;
        
        tabBar.appendChild(tab);
        tabContainer.appendChild(div);
        active(id);
        save();
    }

    function active(id) {
        document.querySelectorAll('.tab-button, .tab-content').forEach(el => 
            el.classList.remove('active-tab', 'active-content')
        );
        document.getElementById(`tab-${id}`).classList.add('active-tab');
        document.getElementById(`content-${id}`).classList.add('active-content');
    }

    function del(id) {
        document.getElementById(`tab-${id}`).remove();
        document.getElementById(`content-${id}`).remove();
        const remaining = document.querySelector('.tab-button');
        if (remaining) active(remaining.id.split('-')[1]);
        save();
    }

    window.save = () => {
        const tabs = Array.from(document.querySelectorAll('.tab-button')).map(tab => {
            const id = tab.id.split('-')[1];
            return {
                name: tab.querySelector('span').textContent,
                content: document.querySelector(`#content-${id} textarea`).value
            };
        });
        localStorage.setItem('tabs', JSON.stringify(tabs));
    };

    function load() {
        const saved = JSON.parse(localStorage.getItem('tabs') || '[]');
        saved.length ? saved.forEach(t => newTab(t.content, t.name)) : newTab();
    }
});


